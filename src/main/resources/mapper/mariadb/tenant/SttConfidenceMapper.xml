<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kt.smp.stt.confidence.mapper.SttConfidenceMapper">

    <select id="confidenceChartData" parameterType="com.kt.smp.stt.confidence.domain.SttConfidenceSearchCondition" resultType="com.kt.smp.stt.confidence.domain.SttConfidenceVO">
		<![CDATA[/*confidenceChartData*/]]>
<!--        SELECT-->
<!--        	<choose>-->
<!--                <when test="searchUnit.name() == 'MONTH'">DATE_FORMAT(isl.START_AT, '%Y-%m-01 00:00')</when>-->
<!--                <when test="searchUnit.name() == 'DAY'">DATE_FORMAT(isl.START_AT, '%Y-%m-%d 00:00')</when>-->
<!--                <when test="searchUnit.name() == 'HOUR'">DATE_FORMAT(isl.START_AT, '%Y-%m-%d %H:00')</when>-->
<!--                <otherwise>DATE_FORMAT(isl.START_AT, '%Y-%m-%d %H:%i')</otherwise>-->
<!--            </choose> AS START_AT,-->
<!--			date_format(isl.START_AT, '%Y-%m-%d %T') as START_AT,-->
<!--			issm.SERVICE_CODE,-->
<!--			issm.SERVICE_MODEL_NAME,-->
<!--			isl.SERVICE_MODEL_ID,-->
<!--			COALESCE(AVG(isl.CER),0.0) AS AVG_CER,-->
<!--			COUNT(1) as COUNT-->
<!--		FROM-->
<!--			IAAP_STT_LOG isl-->
<!--			LEFT JOIN IAAP_STT_SERVICE_MODEL issm ON-->
<!--			CAST(isl.SERVICE_MODEL_ID AS CHAR) = issm.SERVICE_CODE-->
<!--		WHERE 1=1-->
<!--			<if test="serviceCode != null and serviceCode != ''">-->
<!--				AND isl.SERVICE_MODEL_ID = #{serviceCode}-->
<!--			</if>-->
<!--			AND <![CDATA[-->
<!--            isl.START_AT >= #{from}-->
<!--            ]]>-->
<!--        	AND <![CDATA[-->
<!--            isl.START_AT <= #{to}-->
<!--            ]]>-->
<!--		GROUP BY-->
<!--			SERVICE_MODEL_ID,-->
<!--			<choose>-->
<!--	            <when test="searchUnit.name() == 'MONTH'">DATE_FORMAT(isl.START_AT, '%Y-%m')</when>-->
<!--	            <when test="searchUnit.name() == 'DAY'">DATE_FORMAT(isl.START_AT, '%Y-%m-%d')</when>-->
<!--	            <when test="searchUnit.name() == 'HOUR'">DATE_FORMAT(isl.START_AT, '%Y-%m-%d %H')</when>-->
<!--	            <otherwise>DATE_FORMAT(isl.START_AT, '%Y-%m-%d %H:%i')</otherwise>-->
<!--	        </choose>-->
<!--		ORDER BY START_AT-->

        SELECT
        	<choose>
                <when test="searchUnit.name() == 'MONTH'">DATE_FORMAT(isci.CALL_START_TIME, '%Y-%m-01 00:00')</when>
                <when test="searchUnit.name() == 'DAY'">DATE_FORMAT(isci.CALL_START_TIME, '%Y-%m-%d 00:00')</when>
                <when test="searchUnit.name() == 'HOUR'">DATE_FORMAT(isci.CALL_START_TIME, '%Y-%m-%d %H:00')</when>
                <otherwise>DATE_FORMAT(isci.CALL_START_TIME, '%Y-%m-%d %H:%i')</otherwise>
            </choose> AS START_AT,
			isci.SERVICE_CODE,
			issm.SERVICE_MODEL_NAME,
			issm.ID,
			COALESCE(AVG(isri.CONFIDENCE),0.0) AS AVG_CER,
			COUNT(1) as COUNT
		FROM
			IAAP_STT_CALL_INFO AS isci
			LEFT JOIN IAAP_STT_RESULT_INFO AS isri ON
			isci.APPLICATION_ID = isri.APPLICATION_ID 
			LEFT JOIN IAAP_STT_SERVICE_MODEL AS issm ON
			isci.SERVICE_CODE  = issm.SERVICE_CODE
		WHERE 1=1
			<if test="serviceCode != null and serviceCode != ''">
				AND issm.SERVICE_CODE = #{serviceCode}
			</if>
			AND <![CDATA[
            isci.CALL_START_TIME >= #{from}
            ]]>
        	AND <![CDATA[
            isci.CALL_START_TIME <= #{to}
            ]]>
		GROUP BY
			issm.ID,
			isci.SERVICE_CODE,
			issm.SERVICE_MODEL_NAME,
			<choose>
	            <when test="searchUnit.name() == 'MONTH'">DATE_FORMAT(isci.CALL_START_TIME, '%Y-%m')</when>
	            <when test="searchUnit.name() == 'DAY'">DATE_FORMAT(isci.CALL_START_TIME, '%Y-%m-%d')</when>
	            <when test="searchUnit.name() == 'HOUR'">DATE_FORMAT(isci.CALL_START_TIME, '%Y-%m-%d %H')</when>
	            <otherwise>DATE_FORMAT(isci.CALL_START_TIME, '%Y-%m-%d %H:%i')</otherwise>
	        </choose>
		ORDER BY issm.ID
    </select>
</mapper>
