<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layouts/nolayout">
<th:block layout:fragment="html">
	<style>
		.hide {
			display: none;
		}
		.reprocessStatusBtn {
			cursor: pointer;
			color: var(--mdc-theme-primary);
		}
	</style>
    <div class="contentRoot">
        <div class="content-header">
          <h2>재처리 결과 리스트</h2>
        </div>
        <div class="content-body">
            <div class="card">
                <div class="card-header form-row-stack">
                    <div class="form-row multiline-align-top md-size pb-3">
                        <!-- >> 조회기간 -->
                        <div class="flex-auto flex-ratio-two">
                            <div class="form-row h-100">
                                <div id="consultantStartDate"
                                     class="mdc-text-field text-field mdc-text-field--outlined mdc-text-field--with-leading-icon w-100">
                                    <i class="material-icons mdc-text-field__icon">event</i>
                                    <input type="text" class="mdc-text-field__input"
                                           aria-describedby="text-field-outlined-shape-one-helper-text"/>
                                    <div class="mdc-notched-outline mdc-notched-outline--upgraded">
                                        <div class="mdc-notched-outline__leading"></div>
                                        <div class="mdc-notched-outline__notch">
                                            <label class="mdc-floating-label">조회 시작일(from)</label>
                                        </div>
                                        <div class="mdc-notched-outline__trailing"></div>
                                    </div>
                                </div>
                                <div id="consultantEndDate"
                                     class="mdc-text-field text-field mdc-text-field--outlined mdc-text-field--with-leading-icon w-100">
                                    <i class="material-icons mdc-text-field__icon">event</i>
                                    <input type="text" class="mdc-text-field__input"
                                           aria-describedby="text-field-outlined-shape-one-helper-text"/>
                                    <div class="mdc-notched-outline mdc-notched-outline--upgraded">
                                        <div class="mdc-notched-outline__leading"></div>
                                        <div class="mdc-notched-outline__notch">
                                            <label class="mdc-floating-label">조회 종료일(to)</label>
                                        </div>
                                        <div class="mdc-notched-outline__trailing"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="mdc-text-field-helper-line">
                                <p class="mdc-text-field-helper-text mdc-text-field-helper-text--persistent mdc-text-field-helper-text--validation-msg">
                                    조회 시작일이 없는 경우는 전체 기간을 뜻합니다.
                                </p>
                            </div>
                        </div>
                        <!-- << 조회기간 -->
                        <!--24.01.16 재처리 내역 페이지(상담청취) 검색식 select box 삭제-->
                        <!-- 서비스 모델 -->
                        <!--<div id="searchServiceModelSelector"
                             class="mdc-select mdc-select--outlined mdc-select--no-label">
                            <div class="mdc-select__anchor">
                                <div class="mdc-notched-outline">
                                    <span class="mdc-notched-outline__leading"></span>
                                    <div class="mdc-notched-outline__notch">
                                        <label class="mdc-floating-label">서비스 모델</label>
                                    </div>
                                    <span class="mdc-notched-outline__trailing"></span>
                                </div>
                                <span class="mdc-select__selected-text-container overflow-hidden">
                    <span class="mdc-select__selected-text"></span>
                </span>
                                <span class="mdc-select__dropdown-icon"></span>
                            </div>
                            <div class="mdc-select__menu mdc-menu mdc-menu-surface mdc-menu-surface--fullwidth">
                                <ul class="mdc-deprecated-list">
                                    <li class="mdc-deprecated-list-item mdc-deprecated-list-item--selected"
                                        data-value=" "
                                        @click="searchCondition.serviceCode=''"
                                        :class="{'mdc-deprecated-list-item--selected': searchCondition.serviceCode==''}"
                                        :aria-selected="searchCondition.serviceCode=='' ? 'true' : 'false'">
                                        <span class="mdc-deprecated-list-item__ripple"></span>
                                        <span class="mdc-deprecated-list-item__text">전체</span>
                                    </li>
                                    <li v-for="(item, index) in serviceModelList" class="mdc-deprecated-list-item"
                                        :data-value="item.serviceCode"
                                        @click="searchCondition.serviceCode = item.serviceCode"
                                        :class="{'mdc-deprecated-list-item--selected': searchCondition.serviceCode == item.serviceCode} "
                                        :aria-selected="searchCondition.serviceCode == item.serviceCode ? 'true' : 'false'"
                                    >
                                        <span class="mdc-deprecated-list-item__ripple"></span>
                                        <span
                                            class="mdc-deprecated-list-item__text">{{item.serviceModelName}}</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        서비스 모델
                        콜상태
                        <div id="searchCallStatusSelector"
                             class="mdc-select mdc-select--outlined mdc-select--no-label">
                            <div class="mdc-select__anchor">
                                <div class="mdc-notched-outline">
                                    <span class="mdc-notched-outline__leading"></span>
                                    <div class="mdc-notched-outline__notch">
                                        <label class="mdc-floating-label">콜 상태</label>
                                    </div>
                                    <span class="mdc-notched-outline__trailing"></span>
                                </div>
                                <span class="mdc-select__selected-text-container overflow-hidden">
                            <span class="mdc-select__selected-text"></span>
                        </span>
                                <span class="mdc-select__dropdown-icon"></span>
                            </div>
                            <div class="mdc-select__menu mdc-menu mdc-menu-surface mdc-menu-surface--fullwidth">
                                <ul class="mdc-deprecated-list">
                                    <li class="mdc-deprecated-list-item mdc-deprecated-list-item--selected"
                                        data-value=" "
                                        aria-selected="true"
                                        @click="searchCondition.callStatus = ''">
                                        <span class="mdc-deprecated-list-item__ripple"></span>
                                        <span class="mdc-deprecated-list-item__text">전체</span>
                                    </li>
                                    <li class="mdc-deprecated-list-item" :data-value="2000"
                                        @click="searchCondition.callStatus = 2000">
                                        <span class="mdc-deprecated-list-item__ripple"></span>
                                        <span class="mdc-deprecated-list-item__text">진행중</span>
                                    </li>
                                    <li class="mdc-deprecated-list-item" :data-value="3000"
                                        @click="searchCondition.callStatus = 3000">
                                        <span class="mdc-deprecated-list-item__ripple"></span>
                                        <span class="mdc-deprecated-list-item__text">완료</span>
                                    </li>
                                    24.01.16 재처리 select box 삭제
                                    <li class="mdc-deprecated-list-item" :data-value="4000"
                                        @click="searchCondition.callStatus = 4000">
                                        <span class="mdc-deprecated-list-item__ripple"></span>
                                        <span class="mdc-deprecated-list-item__text">재처리</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                         서비스 모델 -->
                    </div>
                    <div class="form-row md-size">
                        <!-- << 상담 번호/콜키, 고객번호 등 검색 -->
                        <div class="mdc-text-field text-field mdc-text-field--outlined flex-auto search-bar">
                            <input type="text" class="mdc-text-field__input"
                                   aria-describedby="text-field-outlined-shape-one-helper-text"
                                   v-model="searchCondition.searchKeyword"/>
                            <div class="mdc-notched-outline mdc-notched-outline--upgraded">
                                <div class="mdc-notched-outline__leading"></div>
                                <div class="mdc-notched-outline__notch">
                                    <label class="mdc-floating-label">검색어</label>
                                </div>
                                <div class="mdc-notched-outline__trailing"></div>
                            </div>
                        </div>
                        <!-- << 상담 번호/콜키, 고객번호 검색 -->
                        <div class="mdc-form-field pe-2">
                            <div class="mdc-radio">
                                <input class="mdc-radio__native-control" type="radio" id="radio-callId"
                                       name="searchKeywordType"
                                       v-model="searchCondition.searchKeywordType" value="callId">
                                <div class="mdc-radio__background">
                                    <div class="mdc-radio__outer-circle"></div>
                                    <div class="mdc-radio__inner-circle"></div>
                                </div>
                                <div class="mdc-radio__ripple"></div>
                                <div class="mdc-radio__focus-ring"></div>
                            </div>
                            <label for="radio-callId">콜키</label>
							<!--24.01.16 재처리 내역 페이지(상담청취) 검색식 radio 버튼 삭제-->
                            <!--<div class="mdc-radio">
                                <input class="mdc-radio__native-control" type="radio" id="radio-applicationId"
                                       name="searchKeywordType" v-model="searchCondition.searchKeywordType"
                                       value="applicationId">
                                <div class="mdc-radio__background">
                                    <div class="mdc-radio__outer-circle"></div>
                                    <div class="mdc-radio__inner-circle"></div>
                                </div>
                                <div class="mdc-radio__ripple"></div>
                                <div class="mdc-radio__focus-ring"></div>
                            </div>
                            <label for="radio-applicationId">어플리케이션 ID</label>

                            <div class="mdc-radio">
                                <input class="mdc-radio__native-control" type="radio" id="radio-recId"
                                       name="searchKeywordType"
                                       v-model="searchCondition.searchKeywordType" value="recId">
                                <div class="mdc-radio__background">
                                    <div class="mdc-radio__outer-circle"></div>
                                    <div class="mdc-radio__inner-circle"></div>
                                </div>
                                <div class="mdc-radio__ripple"></div>
                                <div class="mdc-radio__focus-ring"></div>
                            </div>
                            <label for="radio-recId">녹취ID</label>-->
                        </div>
                        <!-- << 검색 버튼 -->
                        <button class="mdc-button mdc-button--unelevated mdc-ripple-upgraded" @click="search(false)">
                            <span class="mdc-button__ripple"></span>
                            <i class="material-icons mdc-button__icon me-1">search</i>
                            <span class="mdc-button__label">검색</span>
                        </button>
                    </div>
                </div>

                <div class="card-body">
                    <div class="table-controls form-row md-size">
                        <!--검색 결과-->
                        <div class="table-result-info flex-auto">
                            <h4>검색결과 : <span>{{ pageInfo.total }}</span>건</h4>
                        </div>
						<!--24.01.16 스카이라이프 재처리 버튼 삭제-->
                        <!--<button class="mdc-button mdc-button--unelevated mdc-ripple-upgraded" @click="reprocess">
                            <span class="mdc-button__label">재처리</span>
                        </button>-->

                        <!-- >>> 페이지 사이즈 조절 -->
                        <div class="mdc-select mdc-select--outlined mdc-select--no-label">
                            <div class="mdc-select__anchor">
                                <div class="mdc-notched-outline">
                                    <span class="mdc-notched-outline__leading"></span>
                                    <div class="mdc-notched-outline__notch">
                                        <label class="mdc-floating-label">레코드 수</label>
                                    </div>
                                    <span class="mdc-notched-outline__trailing"></span>
                                </div>
                                <span class="mdc-select__selected-text-container overflow-hidden">
                                    <span class="mdc-select__selected-text"></span>
                                </span>
                                <span class="mdc-select__dropdown-icon"></span>
                            </div>
                            <div class="mdc-select__menu mdc-menu mdc-menu-surface mdc-menu-surface--fullwidth">
                                <ul class="mdc-deprecated-list">
                                    <li v-for="ps in pageSizes" class="mdc-deprecated-list-item"
                                        :data-value="ps"
                                        @click="searchCondition.pageSize = ps; currentPage = 1; search();"
                                        :class="{'mdc-deprecated-list-item--selected': searchCondition.pageSize == ps} "
                                        :aria-selected="searchCondition.pageSize == ps ? 'true' : 'false'">
                                        <span class="mdc-deprecated-list-item__ripple"></span>
                                        <span class="mdc-deprecated-list-item__text">{{ ps }}개</span>
                                    </li>

                                </ul>
                            </div>
                        </div>
                        <!-- <<< 페이지 사이즈 조절 -->
                    </div>

                    <!-- 목록 테이블 -->
                    <div class="table-container">
                        <div class="mdc-data-table">
                            <div class="mdc-data-table__table-container">
                                <table class="mdc-data-table__table">
                                    <thead>
                                    <tr class="mdc-data-table__header-row">
                                        <th class="mdc-data-table__header-cell mdc-data-table__header-cell--checkbox text-center" role="columnheader"
                                            scope="col">
                                            <div class="mdc-form-field">
                                                <div
                                                    class="mdc-checkbox mdc-data-table__header-row-checkbox mdc-checkbox--upgraded mdc-checkbox--selected mdc-ripple-upgraded mdc-ripple-upgraded--unbounded">
                                                    <input type="checkbox" class="mdc-checkbox__native-control"
                                                           aria-checked="mixed"
                                                           @click="selectAllRows" id="toggleReprocess"/>
                                                    <div class="mdc-checkbox__background">
                                                        <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                            <path class="mdc-checkbox__checkmark-path" fill="none"
                                                                  d="M1.73,12.91 8.1,19.28 22.79,4.59"></path>
                                                        </svg>
                                                        <div class="mdc-checkbox__mixedmark"></div>
                                                    </div>
                                                    <div class="mdc-checkbox__ripple"></div>
                                                </div>
                                            </div>
                                        </th>
                                        <th class="mdc-data-table__header-cell text-center" role="columnheader"
                                            scope="col">
                                            No.
                                        </th>
                                        <!--24.01.22 스카이 라이프 재처리 결과 페이지에서 항목 삭제-->
                                        <!--<th class="mdc-data-table__header-cell text-center" role="columnheader"
                                            scope="col">
                                            서비스 모델
                                        </th>
                                        <th class="mdc-data-table__header-cell text-center" role="columnheader"
                                            scope="col">
                                            어플리케이션 ID
                                        </th>-->
                                        <th class="mdc-data-table__header-cell text-center" role="columnheader"
                                            scope="col">
                                            콜키
                                        </th>
                                        <th class="mdc-data-table__header-cell text-center" role="columnheader"
                                            scope="col">
                                            콜 시작시간
                                        </th>
                                        <th class="mdc-data-table__header-cell text-center" role="columnheader"
                                            scope="col">
                                            대화록
                                        </th>
                                        <th class="mdc-data-table__header-cell text-center" role="columnheader"
                                            scope="col">
                                            콜 상태
                                        </th>
                                        <!--24.01.22 스카이 라이프 재처리 결과 페이지에서 항목 삭제-->
                                        <!--<th class="mdc-data-table__header-cell text-center" role="columnheader"
                                            scope="col">
                                            재처리 상태
                                        </th>-->
                                    </tr>
                                    </thead>
                                    <tbody class="mdc-data-table__content">
                                    <tr v-if="searchResults.length == 0" class="mdc-data-table__row is-non-clickable"
                                        aria-selected="false"
                                        style="cursor: pointer;">
                                        <td class="mdc-data-table__cell text-center" colspan="9">검색된 결과가 없습니다.</td>
                                    </tr>
                                    <tr v-else v-for="(row, i) in searchResults"
                                        :id="'row-' + row.callId"
                                        class="callinfo-detail-row mdc-data-table__row is-non-clickable"
                                        aria-selected="false">
                                        <td class="mdc-data-table__cell mdc-data-table__cell--checkbox">
                                            <div
                                                class="mdc-checkbox mdc-data-table__row-checkbox mdc-checkbox--upgraded mdc-ripple-upgraded mdc-ripple-upgraded--unbounded">
                                                <input type="checkbox" class="mdc-checkbox__native-control rowChk"
                                                       aria-labelledby="u60" :value="row.applicationId"/>
                                                <div class="mdc-checkbox__background">
                                                    <svg class="mdc-checkbox__checkmark" viewBox="0 0 24 24">
                                                        <path class="mdc-checkbox__checkmark-path" fill="none"
                                                              d="M1.73,12.91 8.1,19.28 22.79,4.59"></path>
                                                    </svg>
                                                    <div class="mdc-checkbox__mixedmark"></div>
                                                </div>
                                                <div class="mdc-checkbox__ripple"></div>
                                            </div>
                                        </td>
                                        <td class="mdc-data-table__cell text-center">
                                            {{ pageInfo.total - ( (currentPage - 1) * searchCondition.pageSize + i) }}
                                        </td>
                                        <!--24.01.22 스카이 라이프 재처리 결과 페이지에서 항목 삭제-->
                                        <!--<td class="mdc-data-table__cell text-center">
                                            {{ row.serviceModelName }}
										</td>
										<td class="mdc-data-table__cell text-center">
											{{ row.applicationId }}
										</td>-->
                                        <td class="mdc-data-table__cell text-center">
                                            {{ row.callId }}
                                        </td>
                                        <td class="mdc-data-table__cell text-center">
                                            {{ row.callStartTime }}
                                        </td>

                                        <td class="mdc-data-table__cell text-center">
                                            <!--24.01.23 stt_status 필드값으로 재처리 완료 여부 판단-->
                                            <!--<div v-if="row.callStatus === 3000 || row.callStatus === 4000 ">-->
                                            <div v-if="row.sttStatus === 'E'">
                                                <div class="callStatusBtn"
                                                     style="cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--mdc-theme-primary);"
                                                     :data-key="row.callId"
                                                     @click="()=> moveToDetail(row.callId)"
                                                     >
                                                     <!--24.01.30 @click="()=> moveToDetail(row.applicationId) 으로 에러 발생시켜서 상세 페이지 막아둠-->
                                                    <i class="material-icons mdc-button__icon me-1">volume_up</i>
                                                    <span style="font-weight: bold;">재생</span>
                                                </div>
                                            </div>
                                            <div v-else>
                                                -
                                            </div>
                                        </td>
                                        <td class="mdc-data-table__cell text-center">
                                            <span v-if="row.sttStatus === 'R' || !row.sttStatus">진행중</span>
                                            <span v-if="row.sttStatus === 'E'">완료</span>
                                            <span v-if="row.sttStatus === 4000">재처리</span>
                                        </td>
                                        <!--24.01.22 스카이 라이프 재처리 결과 페이지에서 항목 삭제-->
                                        <!--<td class="mdc-data-table__cell text-center">
										<div v-if="row.callStatus === 4000">
                                            <a class="table-icon-btn" :id="'reprocessLogBtn_' + row.applicationId"
                                                @click="() => openReprocessLogDialog(row.applicationId)">
                                                <i class="material-icons mdc-button__icon me-1">subject</i>
                                                <span style="font-weight: bold;">이력조회</span>
                                            </a>
										</div>
										
										<template v-else>
											<span v-if="row.reprocessApplicationId == ' '">-</span>
											<div v-else class="reprocessStatusBtn" :id="'reprocessStatus_'+row.applicationId" :data-key="row.applicationId" style="display: flex; align-items: center;justify-content: center;">
                                                <div class="reprocess-status-inner" style="display:flex;">
													<i class="material-icons mdc-button__icon me-1">autorenew</i>
                                                	<span style="font-weight: bold;">진행중</span>
												</div>
											</div>
										</template>
										</td>-->
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- pagination -->
                    <div class="table-pagination mdc-data-table__pagination">
                        <div class="mdc-data-table__pagination-trailing mdc-chip-set mdc-chip-set--choice">
                            <div class="mdc-data-table__pagination-navigation">
                                <button class="mdc-icon-button material-icons mdc-data-table__pagination-button fs-6"
                                        data-first-page="true" @click="gotoPage(1)">
                                    <div class="mdc-button__icon">first_page</div>
                                </button>
                                <button class="mdc-icon-button material-icons mdc-data-table__pagination-button fs-6"
                                        data-prev-page="true" @click="gotoPage(currentPage - 1)">
                                    <div class="mdc-button__icon">chevron_left</div>
                                </button>

                                <button v-for="(paging, index) in pages"
                                        class="mdc-chip mdc-data-table__pagination-button fs-6 bg-transparent"
                                        :class="{ 'mdc-chip--selected' : paging == currentPage }"
                                        @click="gotoPage(paging)">
                                    {{ paging }}
                                </button>
                                <button class="mdc-icon-button material-icons mdc-data-table__pagination-button fs-6"
                                        data-next-page="true" @click="gotoPage(currentPage + 1)">
                                    <div class="mdc-button__icon">chevron_right</div>
                                </button>
                                <button class="mdc-icon-button material-icons mdc-data-table__pagination-button fs-6"
                                        data-last-page="true" @click="gotoPage(pageInfo.pages)">
                                    <div class="mdc-button__icon">last_page</div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="reprocess-log-dialog" class="mdc-dialog mdc-dialog--scrollable" role="alertdialog" aria-modal="true"
             aria-labelledby="simple-dialog-label" aria-describedby="simple-dialog-description">
            <div class="mdc-dialog__scrim"></div>
            <div class="mdc-dialog__container">
                <div class="mdc-dialog__surface">
                    <div class="mdc-dialog__header">
                        <h2 class="mdc-dialog__title">재처리 이력</h2>
                        <button class="mdc-icon-button material-icons close-button" data-mdc-dialog-action="close" tabindex="-1">
                            close
                        </button>
                    </div>

                    <section class="mdc-dialog__content form-row-stack">
                        <p class="mdc-text-field-helper-text mdc-text-field-helper-text--persistent mdc-theme--error">
                            *모든 항목은 필수입력사항입니다.
                        </p>
                        <div class="form-row">
                            <div class="mdc-text-field text-field mdc-text-field--outlined w-100 ">
                                <input type="text" class="mdc-text-field__input"
                                       aria-describedby="text-field-outlined-shape-one-helper-text" readonly required
                                       id="reprocess-id"
                                       value=""/>
                                <div class="mdc-notched-outline mdc-notched-outline--upgraded">
                                    <div class="mdc-notched-outline__leading"></div>
                                    <div class="mdc-notched-outline__notch">
                                        <label class="mdc-floating-label">재처리 ID</label>
                                    </div>
                                    <div class="mdc-notched-outline__trailing"></div>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="mdc-text-field text-field mdc-text-field--outlined w-100 ">
                                <input type="text" class="mdc-text-field__input"
                                       aria-describedby="text-field-outlined-shape-one-helper-text" readonly required
                                       id="reprocess-service-code"
                                       value=""/>
                                <div class="mdc-notched-outline mdc-notched-outline--upgraded">
                                    <div class="mdc-notched-outline__leading"></div>
                                    <div class="mdc-notched-outline__notch">
                                        <label class="mdc-floating-label">서비스 코드</label>
                                    </div>
                                    <div class="mdc-notched-outline__trailing"></div>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="mdc-text-field text-field mdc-text-field--outlined w-100 ">
                                <input type="text" class="mdc-text-field__input"
                                       aria-describedby="text-field-outlined-shape-one-helper-text" readonly required
                                       id="reprocess-date"
                                       value=""/>
                                <div class="mdc-notched-outline mdc-notched-outline--upgraded">
                                    <div class="mdc-notched-outline__leading"></div>
                                    <div class="mdc-notched-outline__notch">
                                        <label class="mdc-floating-label">녹취 시작일시</label>
                                    </div>
                                    <div class="mdc-notched-outline__trailing"></div>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="mdc-text-field text-field mdc-text-field--outlined w-100 ">
                                <input type="text" class="mdc-text-field__input"
                                       aria-describedby="text-field-outlined-shape-one-helper-text" readonly required
                                       id="reprocess-status"
                                       value=""/>
                                <div class="mdc-notched-outline mdc-notched-outline--upgraded">
                                    <div class="mdc-notched-outline__leading"></div>
                                    <div class="mdc-notched-outline__notch">
                                        <label class="mdc-floating-label">진행 상태</label>
                                    </div>
                                    <div class="mdc-notched-outline__trailing"></div>
                                </div>
                            </div>
                        </div>
                    </section>
                    <footer class="mdc-dialog__actions">
                        <button
                                class="mdc-button mdc-button--unelevated mdc-ripple-upgraded mdc-theme--on-default mdc-theme--default-bg dialog-close-btn"
                                data-mdc-dialog-action="close">
                            <span class="mdc-button__ripple"></span>
                            <span class="mdc-button__label">닫기</span>
                        </button>
                    </footer>
                </div>
            </div>
        </div>

    <input type="hidden" readonly id="smpServiceUriPrefix" th:value="${smpServiceUriPrefix}">
    <input type="hidden" readonly id="isStreamMode" th:value="${isStreamMode}">
    <input type="hidden" readonly id="defaultPageSize" th:value="${defaultPageSize}">
</th:block>

<th:block layout:fragment="script">
  <script type="text/javascript">
    (function () {
	  const serviceUrlPrefix = $("#smpServiceUriPrefix").val();
	  const isStreamMode = $("#isStreamMode").val();
	  const DETAIL_PAGE_SERVICE_URI = location.origin + serviceUrlPrefix + "/callinfo/{callId}";
	  const LABEL = {
			  message: {
				  NO_SELECTION : "체크된 콜이 없습니다. 재처리를 위해 하나 이상 체크해주시길 바랍니다.",
				  REPROCESS_DUPLICATED: "선택한 모든 콜이 재처리 중입니다.",
				  FAIL_REPROCESS: "서버 문제로 인해 재처리 요청이 실패하였습니다.\n 잠시 후 다시 시도해주세요",
				  REPROCESS_LOG_NOT_EXIST: "재처리 이력이 없습니다.",
				  DATE_NOT_PICKED: "올바른 조회 일자를 선택해주세요.",
				  INVALID_DATE_RANGE: "기간이 유효하지 않습니다. 다시 선택해주세요.",
				  OVER_END_DATE: "조회 종료일(to)이 오늘 날짜를 넘을 수 없습니다.",
				  OVER_DATE_RANGE: "조회는 최대 30일까지만 가능합니다.",
				  UNKNOWN_ERROR: "알 수 없는 문제로 에러가 발생하였습니다. 담당자에게 문의해주세요."
			  }
		  };
	   			  
	  const callStatus = {
		  1000: "시작",
		  2000: "진행중",
		  3000: "완료",
		  4000: "재처리"
	  }
      new Vue({
        el: ".contentRoot",
        data: {
          reprocessLogDialog: mdc.dialog.MDCDialog.attachTo(document.querySelector('#reprocess-log-dialog')),
          // 검색
          searching: false,
          searchResults: [],
		  searchCondition : {
	          searchKeyword: "",
	          startDate: "",
	          endDate: "",
	          serviceCode: "",
	          callStatus: "",
	          searchKeywordType: "callId",
	          pageSize: $("#defaultPageSize").val()
          },
          searchText: "",
          searchKeyword: "",
          startDate: "",
          endDate: "",
          text: "",
		  serviceModelList: JSON.parse("[[${serviceModelList}]]".replaceAll('&quot;', "\"")),
          // pagination
          pageSizes: [10, 20, 30, 40, 50],
          currentPage: 1,
          pageInfo: {
            pages: 1,
            total: 1
          },
          pageNumLists: [1],
		  reprocessLogObj: {
			  id: "",
			  serviceCode: "",
			  date: "",
			  status: "",
			  result: ""
		  },
          // constant
          DESCRIPTION_MAX_LENGTH: 255
        },
        computed: {
          pages: function () {
            const list = [];
            for (let index = this.startPage; index <= this.endPage; index += 1) {
              list.push(index);
            }
            return list;
          },
          startPage() {
            return parseInt((this.currentPage - 1) / 5) * 5 + 1;
          },
          endPage() {
            var lastPage = parseInt((this.currentPage - 1) / 5 + 1) * 5;
            return lastPage <= this.pageInfo.pages ? lastPage : this.pageInfo.pages;
          }
        },
        created: function () {
          // Base url 받아오기
          const baseUrl = document.querySelector('#smpServiceUriPrefix').value;
          this.baseUrl = baseUrl;

          // 데이터 구분 목록 받아오기
          const self = this;
          
          this.search();

        },
        mounted: function () {
		  console.log(">> callinfo page start");
		  const self = this;
          // 페이지 이동시 처리
          $('#drawer-main-content-viewer').one('page.move', function () {
            // MaterialDatepicker가 화면을 종료해도 자동으로 종료되지 않아 이벤트 unbinding 추가
            const $consultantStartDate = $('#consultantStartDate');
            const $consultantEndDate = $('#consultantEndDate');
            $consultantStartDate.data('datepicker').destroy();
            $consultantEndDate.data('datepicker').destroy();
          });
          
          
          this.initMaterialUx();
          this.initSearchBarEvents();
          
          // >>> 상세 dialog 설정
          const reprocessLogDialog = this.reprocessLogDialog;
          reprocessLogDialog.listen('MDCDialog:opening', function () {
	          // 화면 및 데이터 초기화
	          self.initializeReprocessLogDialog();
          });
          // 상세 dialog 설정
          
        },
        methods: {
          initMaterialUx: function () {
            // ripple material ux 적용
            const elements = document.querySelectorAll('.mdc-ripple-upgraded');
            for (const el of elements) {
              el.class
              mdc.ripple.MDCRipple.attachTo(el, el.classList.contains('mdc-ripple-upgraded--unbounded') ? {
                isUnbounded: true
              } : void 0);
            }

            // input text material ux 적용
            const textFields = document.querySelectorAll('.mdc-text-field');
            for (const textField of textFields) {
              const mdcTextField = mdc.textField.MDCTextField.attachTo(textField);
              $(textField).data('instance', mdcTextField);
            }

            // select material ux 적용
            const selects = document.querySelectorAll('.mdc-select');
            for (const el of selects) {
              const select = mdc.select.MDCSelect.attachTo(el);
              $(el).data('instance', select); //
            }

            // linear progress material ux 적용
            const progresses = document.querySelectorAll('.mdc-linear-progress');
            for (const el of progresses) {
              const progress = mdc.linearProgress.MDCLinearProgress.attachTo(el);
              $(el).data('instance', progress); //
            }

            this.initMaterialDatepickers();
          },
		  initializeReprocessLogDialog: function() {
			// 재처리 id
            $($('#reprocess-id')[0].parentElement).data('instance').value = this.reprocessLogObj.id;
			// 서비스 코드
            $($('#reprocess-service-code')[0].parentElement).data('instance').value = this.reprocessLogObj.serviceCode;
			// 처리 일시
            $($('#reprocess-date')[0].parentElement).data('instance').value = this.reprocessLogObj.date;
			// 진행 상태
            $($('#reprocess-status')[0].parentElement).data('instance').value = this.reprocessLogObj.status;
            
		  },
          // 검색
          search: function (isSearchButtonClicked) {
			const self = this;
            this._setSearching(true);
			
            const searchConditions = {...this.searchCondition}
			
			if (isSearchButtonClicked) {
				searchConditions['pageNum'] = 1;	
			} else {
				searchConditions['pageNum'] = this.currentPage;
			}
			
			if(!searchConditions.startDate && !searchConditions.endDate) {
				// 선택된 날짜가 모두 없는 경우 한달 전 ~ 오늘 날짜로 세팅해서 검색  
					
				const today = new Date(new Date().setHours(23, 59, 59, 999));
				const oneMonthAgo = this.getOneMonthAgoDate(today);
				
	            searchConditions.startDate = moment(oneMonthAgo).format("YYYY-MM-DD");
	            searchConditions.endDate = moment(today).format("YYYY-MM-DD");
	            
			}
			
			if (!this.validateSearchDate(searchConditions.startDate, searchConditions.endDate)) {
				return;
			};
			
            commonObject.deleteNullOrDefaultFields(searchConditions);
            
            $.ajax({
              url: this.baseUrl + "/api/callinfo",
              method: "get",
              contentType: 'application/json; charset=UTF-8',
              data: searchConditions,
              dataType: "json"
            }).done(data => {
              this._setSearchResultsPageInfo(data); // 검색 결과 페이지 정보 저장
              this._setSearchResults(data.result); // 검색 결과 목록
              this.unCheckAllCheckboxs();
               this.$nextTick(function() {
				   
	           	$('.reprocessStatusBtn').unbind('click').bind('click', function (ev) {
					self.getReprocessStatus(ev);
	           	});
	           	
          	  });
          	    
            }).always(() => {
              this._setSearching(false);
            });
          },
		  
          // 검색 이벤트
          initSearchBarEvents: function () {
            const self = this;
            $('.search-bar input').on("keydown", function (e) {
              if (e.keyCode == 13) {
                self.search();
              }
            });
          },

          initMaterialDatepickers: function () {

            // datepicker 적용
            const self = this;
            const $consultantStartDate = $('#consultantStartDate');
            const $consultantEndDate = $('#consultantEndDate');


            // https://github.com/FreddyFY/material-datepicker
            const datepickerOption = {
              lang: "en",
              orientation: "portrait",
              color: document.defaultView.getComputedStyle(document.documentElement).getPropertyValue("--mdc-theme-primary"),
              closeAfterClick: false,
              outputFormat: 'YYYY-MM-DD',
              topHeaderFormat: 'YYYY MM',
              headerFormat: 'Do' // 1st 2nd ... 30th 31st
            };

            if ($consultantStartDate.data('datepicker') != null) {
              $consultantStartDate.data('datepicker').destroy();
            }

            $consultantStartDate.data('datepicker', new MaterialDatepicker($consultantStartDate.data('instance').input, $.extend({}, datepickerOption, {
              onChange: function (date) {
                if (_.isEmpty($consultantStartDate.data('instance').value)) {
                  self.searchCondition.startDate = "";
                } else {
                  self.searchCondition.startDate = moment(date).format("YYYY-MM-DD");
                }
              }
            })));

            if ($consultantEndDate.data('datepicker') != null) {
              $consultantEndDate.data('datepicker').destroy();
            }

            $consultantEndDate.data('datepicker', new MaterialDatepicker($consultantEndDate.data('instance').input, $.extend({}, datepickerOption, {
              onChange: function (date) {
                if (_.isEmpty($consultantEndDate.data('instance').value)) {
                  self.searchCondition.endDate = "";
                } else {
                  self.searchCondition.endDate = moment(date).format("YYYY-MM-DD");
                }
              }
            })));
			
			
			const today = new Date(new Date().setHours(23, 59, 59, 999));
			const oneMonthAgo = this.getOneMonthAgoDate(today);
			
            $consultantStartDate.data('instance').value = moment(oneMonthAgo).format("YYYY-MM-DD");
            $consultantEndDate.data('instance').value = moment(today).format("YYYY-MM-DD");
            this.searchCondition.startDate = moment(oneMonthAgo).format("YYYY-MM-DD");
            this.searchCondition.endDate = moment(today).format("YYYY-MM-DD");
          },
          _setSearchResults: function (resultList) {
             this.searchResults = resultList;
             
          },
          _setSearchResultsPageInfo: function (data) {
            this.pageInfo.pages = data.pages;
            this.pageInfo.total = data.total;
            this.currentPage = data.pageNum;
          },
          _setSearching: function (searching) {
            this.searching = searching;
          },
          // 페이지네이션
          gotoPage: function (pageNum) {
            let validPageNum = pageNum;
            if (pageNum < 1) {
              validPageNum = 1;
            } else if (pageNum > this.pageInfo.pages) {
              validPageNum = this.pageInfo.pages;
            }

            this.currentPage = validPageNum;
            this.search();
          },
          // 재처리 이력 모달 오픈
          openReprocessLogDialog: function (applicationId) {
            const self = this;
            this.getReprocessLog(applicationId);
          },
          // 상세 화면으로 이동
          moveToDetail: function(callId) {
			  //const applicationId = ev.currentTarget.dataset.key;
              window.index.movePage(DETAIL_PAGE_SERVICE_URI.replace("{callId}", callId));
		  },
		  // 모든 row 선택
		  selectAllRows: function() {
			const toggle = $("#toggleReprocess").is(':checked');

            $('.rowChk:checkbox').each(function () {
				const opt = $(this).prop("disabled");
				if (!opt) {
					$(this).prop('checked', toggle);	
				}
            });
		  },
		  // 체크된 모든 Row 가져오기
		  getCheckedRows: function() {
			const checkedApplicationIds = [];
			$('.rowChk:checkbox').each(function () {
               if ( $(this)[0].checked) {
				   checkedApplicationIds.push($(this)[0].value)
			   };
            });
            return checkedApplicationIds;
		  },
		  convertString: function (s) {
         	return s === null ? "" : s;
          },
          reprocess: function() {
			const self = this;
			const checkedApplicationIds = this.getCheckedRows();
			if (checkedApplicationIds.length === 0) {
				toastr.error(LABEL.message.NO_SELECTION);
				return;
			}

			const jsonBody = this.getSearchResultByApplicationIds(checkedApplicationIds);
			
			if (!confirm("선택한 내역에 대한 재처리를 진행하시겠습니까?")) {
				return;
			}
			toastr.success("재처리를 성공적으로 요청하였습니다.");
			this._setSearching(true);
			$.ajax({
              url: this.baseUrl + "/api/reprocess",
              method: "post",
              data: JSON.stringify(jsonBody),
              contentType: 'application/json; charset=UTF-8',
              dataType: "json",
              success: function(response) {
				  self._setSearching(false);
				  if (response.httpStatus === 500) {
					  toastr.error(LABEL.message.FAIL_REPROCESS);
					  return;
				  }
				  if (response.httpStatus === 409) {
					  toastr.error(LABEL.message.REPROCESS_DUPLICATED);
					  return;
				  }
			  },
			  error: function(error) {
				  self._setSearching(false);
				  toastr.error(error.responseText);
			  },
			  complete: function() {
				  // 재처리 후 재검색
				  self.search(false);
			  }
            });
		  },
		  getSearchResultByCallIds: function(callIds) {
			  return this.searchResults.filter((item) => {
				  if (callIds.includes(item.callId)) {
					  return item;
				  }
			  });
		  },
		  getSearchResultByApplicationId: function(applicationId) {
			  return this.searchResults.find((result)=>result.applicationId === applicationId);
		  },
		  getSearchResultByApplicationIds: function(applicationIds) {
			  return this.searchResults.filter((item) => {
				  if (applicationIds.includes(item.applicationId)) {
					  return item;
				  }
			  });
		  },
		  getReprocessStatus: function(ev) {
			if (!confirm("상태 조회를 하시겠습니까?")) {
			   return;
			}
			const self = this;
			const applicationId = ev.currentTarget.dataset.key;
            const $rowEl = $("#row-" + applicationId);
            $rowEl.addClass("processing");

			$.ajax({
              url: this.baseUrl + "/api/callinfo/status",
              method: "GET",
              data: {applicationId},
              contentType: 'application/json; charset=UTF-8',
              dataType: "json",
              success: function(response) {
				  if (!response) {
					  return;
				  }
				  const row = self.getSearchResultByApplicationId(applicationId);

				  if (response === 4000) {
				 	  row.callStatus = 4000;
				 	  return;
				  }
				
				  // $("#reprocessStatus_"+applicationId).text("진행중");
			  },
              complete: function () {
                  $rowEl.removeClass("processing");
                  $rowEl.addClass("is-done");
                  setTimeout(() => {$rowEl.removeClass("is-done")}, 700)
              }
            });
		  },
          // 재처리 상세
          getReprocessLog: function (applicationId) {
				const self = this;
	            $.ajax({
	              url: this.baseUrl + "/api/reprocess/log",
	              data: {applicationId},
	              method: "GET",
	              contentType: 'application/json; charset=UTF-8',
	              dataType: "json",
	              success: function(response) {
					  
					self.reprocessLogObj.id = response.sttId;
					self.reprocessLogObj.applicationId = response.applicationId;
					self.reprocessLogObj.callId = response.callId;
					self.reprocessLogObj.status = response.reprocessStatus;
					self.reprocessLogObj.date = response.recStarttime;
					self.reprocessLogObj.serviceCode = response.serviceCode;
					
					self.reprocessLogDialog.open();
				  },
				  error: function(jqXHR, textStatus, errorThrown) {
					  const statusCode = jqXHR.status;
					  
					  if (statusCode === 404) {
						 toastr.error(LABEL.message.REPROCESS_LOG_NOT_EXIST);
						 return;
					  }
					  
					  if (statusCode === 500) {
						 toastr.error(LABEL.message.UNKNOWN_ERROR);
						 return;
					  }
				  }
	            });
          },
          validateSearchDate: function(startDate, endDate) {
				
			  if(!(startDate && endDate)) {
				  toastr.error(LABEL.message.DATE_NOT_PICKED);
				  return false;
			  }
			  const startDateObj = new Date(startDate);
			  
			  const endDateObj = new Date(endDate);
			  const today = new Date();
				
			  /* 
			  if (endDateObj > today)  {
				  toastr.error(LABEL.message.OVER_END_DATE);
				  return false;
			  }
			  */	  	  
		  	  if (startDateObj > endDateObj) {
				  toastr.error(LABEL.message.INVALID_DATE_RANGE);
				  return false;
			  }
		  	
		  	  const diffMSec = endDateObj.getTime() - startDateObj.getTime();
			  const diffDate = diffMSec / (24 * 60 * 60 * 1000);
			
			  if (diffDate > 30) {
				  toastr.error(LABEL.message.OVER_DATE_RANGE);
				  return false;
			  }
			
			  return true;
		  },
		  getOneMonthAgoDate: function (today) {
			const oneMonthAgo = new Date();
			oneMonthAgo.setDate(today.getDate() - 30);
			return oneMonthAgo;
		  },
		  unCheckAllCheckboxs: function() {
			$("input[type=checkbox]").prop('checked', false);
		  },
        }
      });
    })();
  </script>
</th:block>
</html>
