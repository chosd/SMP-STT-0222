<!DOCTYPE html>
<html lang="ko"
	  xmlns:th="http://www.thymeleaf.org"
	  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="layouts/nolayout">
	<th:block layout:fragment="html">
	<div class="contentRoot mdc-layout-grid__inner pb-3">
		<div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-8">
			<h2>실시간 채널정보</h2>
		</div>
		
		<div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-2 mdc-form-field">
			<div class="mdc-select mdc-select--outlined mdc-select--no-label w-100" id="timeSet-mdc-select">
				<div class="mdc-select__anchor">
					<div class="mdc-notched-outline">
						<span class="mdc-notched-outline__leading"></span>
						<div class="mdc-notched-outline__notch">
							<label class="mdc-floating-label">주기</label>
						</div>
						<span class="mdc-notched-outline__trailing"></span>
					</div>
					<span class="mdc-select__selected-text-container overflow-hidden">
                        <span class="mdc-select__selected-text"></span>
                    </span>
					<span class="mdc-select__dropdown-icon"></span>
				</div>
				
				<div class="mdc-select__menu mdc-menu mdc-menu-surface mdc-menu-surface--fullwidth">
					<ul class="mdc-deprecated-list">
						<li v-for="ts in timeSets" class="mdc-deprecated-list-item"
                            :data-value="ts.key"
                            @click="searchCondition.timeSet = ts.key"
                            :class="{'mdc-deprecated-list-item--selected': searchCondition.timeSet == ts.key} "
                            :aria-selected="searchCondition.timeSet == ts.key ? 'true' : 'false'">
                            <span class="mdc-deprecated-list-item__ripple"></span>
                            <span class="mdc-deprecated-list-item__text">{{ ts.value }}</span>
                        </li>
					</ul>
				</div>
			</div>
		</div>
		<!-- << 주기 선택 -->
		
		<!-- << PLAY/STOP -->
		<div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-1 mdc-form-field">
            <button class="mdc-button mdc-button--raised mdc-ripple-upgraded h-75 w-100 s_active"
					@click="fnStartChannelInfo"
					id="btnStart">
				<span class="mdc-button__ripple"></span>
				<span class="mdc-button__label">PLAY</span>
			</button>
		</div>
		<div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-1 mdc-form-field">
            <button class="mdc-button mdc-button--raised mdc-ripple-upgraded h-75 w-100 s_active"
					@click="fnStopChannelInfo"
					id="btnStop">
				<span class="mdc-button__ripple"></span>
				<span class="mdc-button__label">STOP</span>
			</button>
        </div>
		<!-- << PLAY/STOP -->
		
	</div>
	
	<!-- contents_wrap -->
	<div class="main_content">
		<table class="cnt_hd_box03 tbl_noline tbl_legend">
			<tbody>
			<tr class="tbl_legend right">
				<td class="td_btn_wrap">
					<div class="status_wrap">
						<p>지연: 15초 이상</p>
						<span class="status_delay">지연</span>
						<span class="status_connecting">연결중</span>
						<span class="status_none">연결없음</span>
					</div>
				</td>
			</tr>
			</tbody>
		</table>
		<div id="channelInfoAjax" style="margin-bottom: 20px;"></div>
	</div>
	<!-- contents_wrap -->
	
	<input type="hidden" readonly id="smpServiceUriPrefix" th:value="${smpServiceUriPrefix}">
</th:block>

<th:block layout:fragment="script">
	<link href="/smp/assets/css/common.css" rel="stylesheet" />
	<script type="text/javascript">
        (function () {
            new Vue({
                el: ".contentRoot",
                data: {
                    searchCondition: {
                        timeSet: ""
					},
					timeSets: [],
                    /*serviceCodeMap: {
                        2: "콜봇",
                        3: "준실시간",
                        4: "챗봇"
                    },*/
					serviceCodeMap: {},
                    resultCodeMap: {
                        9999: "기타 알 수 없는 서버 오류가 발생했습니다.",
                        9990: "STT 엔진과의 통신이 원활하지 않습니다. 다시 시도해주세요.",
                        8900: "해당 서비스 모델의 채널정보를 찾을 수 없습니다.",
                        8910: "채널정보 parsing 오류가 발생했습니다.",
                        8920: "채널정보 조회 관련 비동기 처리 오류가 발생했습니다.",
                    },
                    timeoutId: 0
                },
                computed: {},
                created: function () {
                    
                    // Base url 받아오기
                    const baseUrl = document.querySelector('#smpServiceUriPrefix').value;
                    this.baseUrl = baseUrl;

                    // 데이터 구분 목록 받아오기
                    var self = this;

					this.initTimeSet(() => {

                        // 주기 mdc-select 초기화
						self.$nextTick(function () {
							const $select = $("#timeSet-mdc-select")[0];
							$($select).data('instance').destroy();
	
							const newMdcSelect = new mdc.select.MDCSelect($select);
							$($select).data('instance', newMdcSelect);
                            
                            // 주기 mdc-select 기본 값
                            $($select).data('instance').value = "5";
						})
					})
					
					this.initServiceModelMap();
					
                    this.getChannelInfo();
                    this.fnStartChannelInfo();
                },
                mounted: function () {
                    this.initMaterialUx();
                },
                methods: {
                    initMaterialUx: function () {
                        // ripple material ux 적용
                        const elements = document.querySelectorAll('.mdc-ripple-upgraded');
                        for (const el of elements) {
                            el.class
                            mdc.ripple.MDCRipple.attachTo(el, el.classList.contains('mdc-ripple-upgraded--unbounded') ? {
                                isUnbounded: true
                            } : void 0);
                        }

                        // select material ux 적용
                        const selects = document.querySelectorAll('.mdc-select');
                        for (const el of selects) {
                            const select = mdc.select.MDCSelect.attachTo(el);
                            $(el).data('instance', select); //
                        }
                    },

                    // 팝업 데이터 초기화
                    initTimeSet: function (callback) {
                        this.timeSets = [
                            {key: 5, value: "5초"},
                            {key: 10, value: "10초"},
                            {key: 30, value: "30초"}
                        ];
                        callback();
                    },
					
					// 서비스 모델 map 초기화
                    initServiceModelMap: function () {
                        $.ajax({
                            url: this.baseUrl + "/trainData/api/serviceModelList",
                            method: "get",
                            contentType: 'application/json; charset=UTF-8',
                            dataType: "json"
                        }).done(data => {
                            var resultMap = {};
                            if (data && data.result && data.result.length > 0) {
                                var result = data.result;
                                result.forEach(r => {
                                    resultMap[r.serviceCode] = r.serviceModelName;
                                })
                            }
                            this.serviceCodeMap = resultMap;
                        });
                    },

                    getChannelInfo: function () {

                        this.fnAbleStopBtn();

                        var self = this;

                        $.ajax({
                            url: this.baseUrl + "/channel/api/list",
                            method: "get",
                            dataType: "html",
                            success: function (data) {
                                $("#channelInfoAjax").html('');
                                var html = '';

                                if (data) {
                                    var json = JSON.parse(data);
                                    console.log(json);
                                    if (json.resultCode == '0000') { // 성공일 때,
                                        for (var i = 0; i < json.result.sruInfoList.length; i++) {
                                            var sru = json.result.sruInfoList[i];
                                            html += '<div class="content_main sru_container"">';
                                            html += '<div class="sru_wrap grid_2" style="min-height: 50px; margin-top: 0">';
                                            html += '<div class="sru_tit"><p>' + sru.sruName + '<br></p></div>';
                                            html += '<div class="sru_channel_info_container">';

                                            if (sru.svcChannelInfoList != null) {
                                                if (sru.svcChannelInfoList.length == 0) {

                                                    html = '<div class="sru_channel_info_no_data">데이터가 존재하지 않습니다.</div>';

                                                } else {

                                                    for (var j = 0; j < sru.svcChannelInfoList.length; j++) {

                                                        var serviceModel = sru.svcChannelInfoList[j];
                                                        html += '<div class="sru_callbot sru_service_model_container">';
                                                        html += '<div class="sru_tit"><p>' + (self.convertServiceCodeLabel(serviceModel.serviceCode)) + '<br>(' + serviceModel.channelCount + ')</p></div>';
                                                        html += '<div class="sru_channel_info">';

                                                        if (serviceModel.channelInfoList != null) {
                                                            for (var h = 0; h < serviceModel.channelInfoList.length; h++) {
                                                                var status = serviceModel.channelInfoList[h];

                                                                if (status.status == 'ready') {
                                                                    html += '<div class="status_none"></div>';
                                                                } else if (status.status == 'delay') {
                                                                    html += '<div class="status_delay"></div>';
                                                                } else if (status.status == 'inuse') {
                                                                    html += '<div class="status_connecting"></div>';
                                                                }
                                                            }
                                                        }
                                                        html += '</div>';
                                                        html += '</div>';
                                                    }
                                                }

                                            } else {
                                                html += '<div class="sru_callbot sru_service_model_container"">';
                                                html += '<div class="sru_tit"><p>' + 'N/A' + '<br></p></div>';
                                                html += '<div class="sru_channel_info">';
                                            }
                                            html += '</div>';
                                            html += '</div>';
                                            html += '</div>';
                                        }
                                    } else { // error code
                                        html = '<div class="sru_channel_info_no_data">' + self.convertResultCodeMessage(json.resultCode) + '</div>';
                                        self.fnStopChannelInfo();
                                    }

                                    $("#channelInfoAjax").html(html);
                                }

                            },
                            error: function (xhr, status, error) { // 서버와의 통신 오류
                                $("#channelInfoAjax").html('')
                                var html = '<div class="sru_channel_info_no_data">서버와의 통신이 원활하지 않습니다. 다시 시도해 주십시오.</div>';
                                $("#channelInfoAjax").append(html);
                                self.fnStopChannelInfo();
                            }
                        });
                    },
                    fnStartChannelInfo: function () {
                        if (this.timeoutId) {
                            clearTimeout(this.timeoutId);
                        }
                        this.getChannelInfo();
						
                        this.timeoutId = setInterval(this.getChannelInfo, (this.searchCondition.timeSet ? this.searchCondition.timeSet : 5)  * 1000);
                    },
                    fnStopChannelInfo: function () {
                        this.fnEnableStopBtn();
                        clearTimeout(this.timeoutId);
                        this.timeoutId = null;
                    },
                    fnAbleStopBtn: function () {
                        $('#btnStop').removeClass('s_inactive');
                        $('#btnStop').addClass('s_active');
                    },
                    fnEnableStopBtn: function () {
                        $('#btnStop').removeClass('s_active');
                        $('#btnStop').addClass('s_inactive');
                    },
                    convertServiceCodeLabel: function (serviceCode) {
                        var result = "알 수 없음";
                        if (serviceCode) {
                            if (this.serviceCodeMap.hasOwnProperty(serviceCode)) {
                                return this.serviceCodeMap[serviceCode];
                            }
                        }
                        return result
                    },
                    convertResultCodeMessage: function (resultCode) {
                        var result = "알 수 없는 오류가 발생하였습니다.";
                        if (resultCode) {
                            if (this.resultCodeMap.hasOwnProperty(resultCode)) {
                                return this.resultCodeMap[resultCode];
                            }
                        }
                        return result
                    }
                }
            });
        })();
	</script>
</th:block>
</html>
