<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layouts/nolayout">
<th:block layout:fragment="html">
    <div class="contentRoot">
        <div class="content-header">
            <h2>STT 통계</h2>
        </div>

        <div class="content-body">
            <div class="card">
                <div class="card-header">
                    <!-- >>> 검색 바 -->
                    <div class="form-row md-size">
                        <!-- >> 서비스 모델 검색 -->
                        <div class="mdc-select mdc-select--outlined mdc-select--no-label mdc-select--required"
                             id="serviceModels-mdc-select">
                            <div class="mdc-select__anchor" aria-required="true">
                                <div class="mdc-notched-outline">
                                    <span class="mdc-notched-outline__leading"></span>
                                    <div class="mdc-notched-outline__notch">
                                        <label class="mdc-floating-label mdc-floating-label--required">
                                            서비스 모델
                                        </label>
                                    </div>
                                    <span class="mdc-notched-outline__trailing"></span>
                                </div>
                                <span class="mdc-select__selected-text-container overflow-hidden">
                                    <span class="mdc-select__selected-text"></span>
                                </span>
                                <span class="mdc-select__dropdown-icon"></span>
                            </div>
                            <div class="mdc-select__menu mdc-menu mdc-menu-surface mdc-menu-surface--fullwidth">
                                <ul class="mdc-deprecated-list">
                                    <li class="mdc-deprecated-list-item" data-value="''"
                                        @click="searchCondition.serviceCode=''"
                                        :class="{'mdc-deprecated-list-item--selected': searchCondition.serviceCode==''}"
                                        :aria-selected="searchCondition.serviceCode=='' ? 'true' : 'false'">
                                        <span class="mdc-deprecated-list-item__ripple"></span>
                                        <span class="mdc-deprecated-list-item__text">전체</span>
                                    </li>
                                    <li v-for="serviceModel in serviceModelList" class="mdc-deprecated-list-item"
                                        :data-value="serviceModel.serviceCode"
                                        @click="searchCondition.serviceCode = serviceModel.serviceCode"
                                        :class="{'mdc-deprecated-list-item--selected': searchCondition.serviceCode == serviceModel.serviceCode} "
                                        :aria-selected="searchCondition.serviceCode == serviceModel.serviceCode ? 'true' : 'false'">

                                        <span class="mdc-deprecated-list-item__ripple"></span>
                                        <span
                                            class="mdc-deprecated-list-item__text">{{ serviceModel.serviceModelName }}</span>
                                    </li>
                                </ul>
                            </div>
                        </div>
                        <!-- << 서버 검색 -->

                        <!-- >> 검색 단위 선택 -->
                        <div>
                            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-3 mdc-form-field">
                                <span>검색 단위</span>
                            </div>
                            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-2 mdc-form-field">
                                <div class="mdc-radio">
                                    <input class="mdc-radio__native-control" type="radio" id="radio-search-unit-minute"
                                           name="searchUnit" checked @click="onClickSearchUnit"
                                           value="MINUTE">
                                    <div class="mdc-radio__background">
                                        <div class="mdc-radio__outer-circle"></div>
                                        <div class="mdc-radio__inner-circle"></div>
                                    </div>
                                    <div class="mdc-radio__ripple"></div>
                                    <div class="mdc-radio__focus-ring"></div>
                                </div>
                                <label for="radio-search-unit-minute">분</label>
                            </div>
                            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-3 mdc-form-field">
                                <div class="mdc-radio">
                                    <input class="mdc-radio__native-control" type="radio" id="radio-search-unit-hour"
                                           name="searchUnit" @click="onClickSearchUnit"
                                           value="HOUR">
                                    <div class="mdc-radio__background">
                                        <div class="mdc-radio__outer-circle"></div>
                                        <div class="mdc-radio__inner-circle"></div>
                                    </div>
                                    <div class="mdc-radio__ripple"></div>
                                    <div class="mdc-radio__focus-ring"></div>
                                </div>
                                <label for="radio-search-unit-hour">시간</label>
                            </div>
                            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-2 mdc-form-field">
                                <div class="mdc-radio">
                                    <input class="mdc-radio__native-control" type="radio" id="radio-search-unit-day"
                                           name="searchUnit" @click="onClickSearchUnit"
                                           value="DAY">
                                    <div class="mdc-radio__background">
                                        <div class="mdc-radio__outer-circle"></div>
                                        <div class="mdc-radio__inner-circle"></div>
                                    </div>
                                    <div class="mdc-radio__ripple"></div>
                                    <div class="mdc-radio__focus-ring"></div>
                                </div>
                                <label for="radio-search-unit-day">일</label>
                            </div>
                        </div>
                        <!-- << 검색 단위 선택 -->

                        <!-- >> 검색 기간 -->
                        <div class="form-row flex-auto">
                            <div class="flex-auto flex-ratio-two">
                                <div id="start-date-mdc"
                                     class="mdc-text-field text-field mdc-text-field--outlined mdc-text-field--with-leading-icon w-100">
                                    <input type="text" class="mdc-text-field__input ps-3"
                                           aria-describedby="text-field-outlined-shape-one-helper-text"
                                           :value="searchCondition.from"
                                    />
                                    <div class="mdc-notched-outline mdc-notched-outline--upgraded">
                                        <div class="mdc-notched-outline__leading"></div>
                                        <div class="mdc-notched-outline__notch">
                                            <label class="mdc-floating-label">통계 시작일</label>
                                        </div>
                                        <div class="mdc-notched-outline__trailing"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-auto">
                                <div id="start-time-mdc"
                                     class="mdc-text-field text-field mdc-text-field--outlined mdc-text-field--with-leading-icon w-100">
                                    <input type="text" class="mdc-text-field__input ps-3"
                                           aria-describedby="text-field-outlined-shape-one-helper-text"
                                           :value="searchCondition.startSearchTime"
                                    />
                                    <div class="mdc-notched-outline mdc-notched-outline--upgraded">
                                        <div class="mdc-notched-outline__leading"></div>
                                        <div class="mdc-notched-outline__notch">
                                            <label class="mdc-floating-label">통계 시작 시간</label>
                                        </div>
                                        <div class="mdc-notched-outline__trailing"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-auto flex-ratio-two">
                                <div id="end-date-mdc" class="mdc-text-field text-field mdc-text-field--outlined mdc-text-field--with-leading-icon w-100">
                                    <input type="text" class="mdc-text-field__input ps-3"
                                           aria-describedby="text-field-outlined-shape-one-helper-text"
                                           :value="searchCondition.to"
                                    />
                                    <div class="mdc-notched-outline mdc-notched-outline--upgraded">
                                        <div class="mdc-notched-outline__leading"></div>
                                        <div class="mdc-notched-outline__notch">
                                            <label class="mdc-floating-label">통계 종료일</label>
                                        </div>
                                        <div class="mdc-notched-outline__trailing"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex-auto">
                                <div id="end-time-mdc"
                                     class="mdc-text-field text-field mdc-text-field--outlined mdc-text-field--with-leading-icon w-100">
                                    <input type="text" class="mdc-text-field__input ps-3"
                                           aria-describedby="text-field-outlined-shape-one-helper-text"
                                           :value="searchCondition.endSearchTime"
                                    />
                                    <div class="mdc-notched-outline mdc-notched-outline--upgraded">
                                        <div class="mdc-notched-outline__leading"></div>
                                        <div class="mdc-notched-outline__notch">
                                            <label class="mdc-floating-label">통계 종료 시간</label>
                                        </div>
                                        <div class="mdc-notched-outline__trailing"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- << 검색 기간 -->

                        <button class="mdc-button mdc-button--unelevated mdc-ripple-upgraded"
                                @click="searchChart(); search();">
                            <span class="mdc-button__ripple"></span>
                            <i class="material-icons mdc-button__icon me-1">search</i>
                            <span class="mdc-button__label">검색</span>
                        </button>
                        <!-- <<< 검색 바 -->
                    </div>
                </div>
                <div class="card-body custom-scrollbar">
                    <div class="table-controls form-row md-size">
                        <div class="table-result-info flex-auto">
                            <h4>검색결과 : <span>{{ pageInfo.total }}</span>건</h4>
                        </div>
                        <!-- <<< 그래프 모양 선택 -->
                        <!--
						<div>
                            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-2 mdc-form-field">
                                <div class="mdc-radio">
                                    <input class="mdc-radio__native-control" type="radio" id="radio-graphType-bar"
                                           name="graphType" checked @click="onClickGraphType"
                                           value="bar">
                                    <div class="mdc-radio__background">
                                        <div class="mdc-radio__outer-circle"></div>
                                        <div class="mdc-radio__inner-circle"></div>
                                    </div>
                                    <div class="mdc-radio__ripple"></div>
                                    <div class="mdc-radio__focus-ring"></div>
                                </div>
                                <label for="radio-graphType-bar">막대</label>
                            </div>
                            <div class="mdc-layout-grid__cell mdc-layout-grid__cell--span-3 mdc-form-field">
                                <div class="mdc-radio">
                                    <input class="mdc-radio__native-control" type="radio" id="radio-graphType-line"
                                           name="graphType" @click="onClickGraphType"
                                           value="line">
                                    <div class="mdc-radio__background">
                                        <div class="mdc-radio__outer-circle"></div>
                                        <div class="mdc-radio__inner-circle"></div>
                                    </div>
                                    <div class="mdc-radio__ripple"></div>
                                    <div class="mdc-radio__focus-ring"></div>
                                </div>
                                <label for="radio-graphType-line">선형</label>
                            </div>
                        </div>-->
                        <!-- >>> 페이지 사이즈 조절 -->
                        <div class="mdc-select mdc-select--outlined mdc-select--no-label">
                                <div class="mdc-select__anchor">
                                    <div class="mdc-notched-outline">
                                        <span class="mdc-notched-outline__leading"></span>
                                        <div class="mdc-notched-outline__notch">
                                            <label class="mdc-floating-label">레코드 수</label>
                                        </div>
                                        <span class="mdc-notched-outline__trailing"></span>
                                    </div>
                                    <span class="mdc-select__selected-text-container overflow-hidden">
                                        <span class="mdc-select__selected-text"></span>
                                    </span>
                                    <span class="mdc-select__dropdown-icon"></span>
                                </div>
                                <div class="mdc-select__menu mdc-menu mdc-menu-surface mdc-menu-surface--fullwidth">
                                    <ul class="mdc-deprecated-list">
                                        <li v-for="ps in pageSizes" class="mdc-deprecated-list-item"
                                            :data-value="ps"
                                            @click="searchCondition.pageSize = ps; currentPage = 1; search();"
                                            :class="{'mdc-deprecated-list-item--selected': searchCondition.pageSize == ps} "
                                            :aria-selected="searchCondition.pageSize == ps ? 'true' : 'false'">
                                            <span class="mdc-deprecated-list-item__ripple"></span>
                                            <span class="mdc-deprecated-list-item__text">{{ ps }}개</span>
                                        </li>

                                    </ul>
                                </div>
                            </div>
                        <!-- <<< 페이지 사이즈 조절 -->
                    </div>
                    <!-- loading bar -->
                    <div v-show="searching" role="progressbar"
                         class="mdc-linear-progress mdc-linear-progress--indeterminate"
                         style="opacity: 1;">
                        <div class="mdc-linear-progress__buffering-dots"></div>
                        <div class="mdc-linear-progress__buffer"></div>
                        <div class="mdc-linear-progress__bar mdc-linear-progress__primary-bar">
                            <span class="mdc-linear-progress__bar-inner"></span>
                        </div>
                        <div class="mdc-linear-progress__bar mdc-linear-progress__secondary-bar">
                            <span class="mdc-linear-progress__bar-inner"></span>
                        </div>
                    </div>

                    <div class="content-item chart_area">
                        <div style="width: 100%; height: 100%; position: relative;">
                            <div id="noDataTextField"
                                 style="text-align: center; width: 100%; height: 100%; position: absolute; left: 0; top: 38%; z-index: 2;">
                                <p>데이터가 없습니다.</p>
                            </div>
                            <canvas id="myChart" height="50"></canvas>
                        </div>
                    </div>

                    <div class="table-container">
                        <div class="mdc-data-table">
                            <div class="mdc-data-table__table-container">
                                <table class="mdc-data-table__table">
                                    <thead>
                                    <tr>
                                        <th class="mdc-data-table__header-cell text-center" role="columnheader"
                                            rowspan="2">
                                            No.
                                        </th>
                                        <th class="mdc-data-table__header-cell text-center"
                                            role="columnheader" rowspan="2">
                                            일시
                                        </th>
                                        <th class="mdc-data-table__header-cell text-center"
                                            role="columnheader" rowspan="2">
                                            서비스 모델
                                        </th>
                                        <th class="mdc-data-table__header-cell text-center"
                                            role="columnheader" rowspan="2">
                                            요청수
                                        </th>
                                        <th class="mdc-data-table__header-cell text-center" role="columnheader"
                                            colspan="2">
                                            완료수
                                        </th>
<!--                                        <th class="mdc-data-table__header-cell text-center" role="columnheader"-->
<!--                                            rowspan="2">-->
<!--                                            미완료수-->
<!--                                        </th>-->
                                    </tr>
                                    <tr>
                                        <th class="mdc-data-table__header-cell text-center" role="columnheader">
                                            성공수
                                        </th>
                                        <th class="mdc-data-table__header-cell text-center" role="columnheader">
                                            실패수
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody class="mdc-data-table__content">
                                    <template v-if="searchResults.length == 0">
                                        <tr class="mdc-data-table__row" aria-selected="false">
                                            <td class="mdc-data-table__cell text-center" colspan="7">검색된 결과가 없습니다.
                                            </td>
                                        </tr>
                                    </template>
                                    <template v-else v-for="(row, j) in searchResults">
                                        <template v-if="hashmap != null" class="detail-service-row mdc-data-table__row"
                                                  aria-selected="false">
                                            <tr v-for="(serviceModelValue, i) in serviceModelList">
                                                <template v-if="i == 0">
                                                    <th class="mdc-data-table__cell text-center"
                                                        :rowspan="serviceModelList.length">
                                                        {{
                                                        pageInfo.total - ( (currentPage - 1) * searchCondition.pageSize
                                                        + j)
                                                        }}
                                                    </th>
                                                    <td class="mdc-data-table__cell text-center"
                                                        :rowspan="serviceModelList.length">
                                                        {{
                                                        row.regDt }}
                                                    </td>
                                                </template>
                                                <td class="mdc-data-table__cell text-center">{{
                                                    serviceModelValue.serviceModelName
                                                    }}
                                                </td>
                                                <td v-if="hashmap[serviceModelValue.serviceCode].length > j"
                                                    class="mdc-data-table__cell text-center">{{
                                                    hashmap[serviceModelValue.serviceCode][j].requestCount }}
                                                </td>
                                                <td v-else class="mdc-data-table__cell text-center">NA</td>
                                                <td v-if="hashmap[serviceModelValue.serviceCode].length > j"
                                                    class="mdc-data-table__cell text-center">{{
                                                    hashmap[serviceModelValue.serviceCode][j].completeCount }}
                                                </td>
                                                <td v-else class="mdc-data-table__cell text-center">NA</td>
                                                <td v-if="hashmap[serviceModelValue.serviceCode].length > j"
                                                    class="mdc-data-table__cell text-center">{{
                                                    hashmap[serviceModelValue.serviceCode][j].failCount }}
                                                </td>
                                                <td v-else class="mdc-data-table__cell text-center">NA</td>
<!--                                                <template v-if="hashmap[serviceModelValue.serviceCode].length > j">-->
<!--                                                    <template-->
<!--                                                        v-if="hashmap[serviceModelValue.serviceCode][j].busyCallCount != null">-->
<!--                                                        <td class="mdc-data-table__cell text-center">{{-->
<!--                                                            hashmap[serviceModelValue.serviceCode][j].busyCallCount }}-->
<!--                                                        </td>-->
<!--                                                    </template>-->
<!--                                                    <template v-else>-->
<!--                                                        <td class="mdc-data-table__cell text-center">NA</td>-->
<!--                                                    </template>-->
<!--                                                </template>-->
<!--                                                <template v-else>-->
<!--                                                    <td class="mdc-data-table__cell text-center">NA</td>-->
<!--                                                </template>-->
                                            </tr>
                                        </template>
                                        <template v-else>
                                            <tr class="detail-service-row mdc-data-table__row"
                                                aria-selected="false">
                                                <th class="mdc-data-table__cell text-center" rowspan="1">{{
                                                    pageInfo.total -
                                                    (
                                                    (currentPage - 1) * searchCondition.pageSize + j) }}
                                                </th>
                                                <td class="mdc-data-table__cell text-center" rowspan="1">{{ row.regDt }}
                                                </td>
                                                <td class="mdc-data-table__cell text-center">{{
                                                    convertServiceModelId2Name(row.serviceCode) }}
                                                </td>
                                                <td class="mdc-data-table__cell text-center">{{ row.requestCount }}</td>
                                                <td class="mdc-data-table__cell text-center">{{ row.completeCount }}
                                                </td>
                                                <td class="mdc-data-table__cell text-center">{{ row.failCount }}</td>
<!--                                                <td class="mdc-data-table__cell text-center">{{ row.busyCallCount }}-->
                                                </td>
                                            </tr>
                                        </template>
                                    </template>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- pagination -->
                    <div class="table-pagination mdc-data-table__pagination">
                        <div class="mdc-data-table__pagination-trailing mdc-chip-set mdc-chip-set--choice">
                            <div class="mdc-data-table__pagination-navigation">
                                <button class="mdc-icon-button material-icons mdc-data-table__pagination-button fs-6"
                                        data-first-page="true" @click="gotoPage(1)">
                                    <div class="mdc-button__icon">first_page</div>
                                </button>
                                <button class="mdc-icon-button material-icons mdc-data-table__pagination-button fs-6"
                                        data-prev-page="true" @click="gotoPage(currentPage - 1)">
                                    <div class="mdc-button__icon">chevron_left</div>
                                </button>

                                <button v-for="(paging, index) in pages"
                                        class="mdc-chip mdc-data-table__pagination-button fs-6 bg-transparent"
                                        :class="{ 'mdc-chip--selected' : paging == currentPage }"
                                        @click="gotoPage(paging)">
                                    {{ paging }}
                                </button>
                                <button class="mdc-icon-button material-icons mdc-data-table__pagination-button fs-6"
                                        data-next-page="true" @click="gotoPage(currentPage + 1)">
                                    <div class="mdc-button__icon">chevron_right</div>
                                </button>
                                <button class="mdc-icon-button material-icons mdc-data-table__pagination-button fs-6"
                                        data-last-page="true" @click="gotoPage(pageInfo.pages)">
                                    <div class="mdc-button__icon">last_page</div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <input type="hidden" readonly id="smpServiceUriPrefix" th:value="${smpServiceUriPrefix}">
</th:block>

<th:block layout:fragment="script">
	<script type="text/javascript" th:src='${smpServiceUriPrefix + "/js/chartjsMomentAdapter.js"}'></script>
    <script type="text/javascript">

        (function () {
            var LABEL = {
                searchCondition: {
                    "pageSize": 50,
                    serviceModelId: "",
                    serviceCode: "",
                    searchUnit: "MINUTE",
                    from: moment(new Date()).format("YYYY-MM-DD"),
                    startSearchTime: "00:00",
                    to: moment(new Date()).format("YYYY-MM-DD"),
                    endSearchTime: "23:59",
                    pageSize: 50
                },
                graphAxisUnit: {
					MINUTE: "yyyy-MM-DD HH:mm:ss",
					HOUR: "yyyy-MM-DD HH",
					DAY: "yyyy-MM-DD"
				},
                message: {
					OVER_DATE_RANGE: "조회는 최대 31일까지만 가능합니다.",
				}
            };
            new Vue({
                el: ".contentRoot",
                data: {

                    baseUrl: "",

                    // 검색
                    searchCondition: {...LABEL.searchCondition},
                    searching: false, // 검색중
                    searchResults: [], // 검색 결과
                    serviceModelList: JSON.parse("[[${serviceModelList}]]".replaceAll('&quot;', "\"")),
                    hashmap: [],
                    SERVICE_MODEL_ID_TO_NAME: {},

                    // pagination
                    pageSizes: [10, 20, 30, 40, 50], // page size 목록
                    currentPage: 1,
                    pageInfo: {
                        pages: 1,
                        total: 1
                    },
                    pageNumLists: [1],

                    // 차트
                    myChart: {},
                    chartData: {},
					graphOption: {
						graphType: "line",
						displayTimeUnit: LABEL.graphAxisUnit.MINUTE,
					}
                },
                computed: {
                    pages: function () {
                        const list = [];
                        for (let index = this.startPage; index <= this.endPage; index += 1) {
                            list.push(index);
                        }
                        return list;
                    },
                    startPage() {
                        return parseInt((this.currentPage - 1) / 5) * 5 + 1;
                    },
                    endPage() {
                        var lastPage = parseInt((this.currentPage - 1) / 5 + 1) * 5;
                        return lastPage <= this.pageInfo.pages ? lastPage : this.pageInfo.pages;
                    }
                },
                created: function () {
                    // Base url 받아오기
                    const baseUrl = document.querySelector('#smpServiceUriPrefix').value;
                    this.baseUrl = baseUrl;

                    // 서비스 목록 받아오기
                    var self = this;

                    this.initServiceModel()

                    // 검색
                    //this.search(false);
                },
                mounted: function () {

                    // 페이지 이동시 처리
                    $('#drawer-main-content-viewer').one('page.move', function () {
                        console.log("page move out");

                        // MaterialDatepicker가 화면을 종료해도 자동으로 종료되지 않아 이벤트 unbinding 추가
                        var $startDateMdc = $('#start-date-mdc');
                        var $startTimeMdc = $('#start-time-mdc');
                        var $endDateMdc = $('#end-date-mdc');
                        var $endTimeMdc = $('#end-time-mdc');
                        $startDateMdc.data('datepicker').destroy();
                        $($startTimeMdc.data('instance').input).timepicker('remove');
                        $endDateMdc.data('datepicker').destroy();
                        $($endTimeMdc.data('instance').input).timepicker('remove');
                    });

                    this.initMaterialUx();
                    this.initSearchBarEvents();
					
					this.makeGraph(this.graphOption.graphType);
                    
                },
                methods: {
                    // 화면 초기화
                    initMaterialUx: function () {

                        // ripple material ux 적용
                        const elements = document.querySelectorAll('.mdc-ripple-upgraded');
                        for (const el of elements) {
                            el.class
                            mdc.ripple.MDCRipple.attachTo(el, el.classList.contains('mdc-ripple-upgraded--unbounded') ? {
                                isUnbounded: true
                            } : void 0);
                        }

                        // input text material ux 적용
                        const textFields = document.querySelectorAll('.mdc-text-field');
                        for (const textField of textFields) {
                            const mdcTextField = mdc.textField.MDCTextField.attachTo(textField);
                            $(textField).data('instance', mdcTextField); //
                        }

                        // select material ux 적용
                        const selects = document.querySelectorAll('.mdc-select');
                        for (const el of selects) {
                            const select = mdc.select.MDCSelect.attachTo(el);
                            $(el).data('instance', select); //
                        }

                        this.initMaterialDatepickers();
                        this.initTimepickers();
                    },
                    initMaterialDatepickers: function () {

                        // datepicker 적용
                        var self = this;
                        var $startAtInput = $('#start-date-mdc');
                        var $endAtInput = $('#end-date-mdc');

                        var today = moment(new Date()).format("YYYY-MM-DD");

                        // https://github.com/FreddyFY/material-datepicker
                        var datepickerOption = {
                            lang: "en",
                            orientation: "portrait",
                            color: document.defaultView.getComputedStyle(document.documentElement).getPropertyValue("--mdc-theme-primary"),
                            closeAfterClick: false,
                            outputFormat: 'YYYY-MM-DD',
                            topHeaderFormat: 'YYYY MM',
                            headerFormat: 'Do' // 1st 2nd ... 30th 31st
                        };

                        if ($startAtInput.data('datepicker') != null) {
                            $startAtInput.data('datepicker').destroy();
                        }

                        $startAtInput.data('datepicker', new MaterialDatepicker($startAtInput.data('instance').input, $.extend({}, datepickerOption, {
                            onChange: function (date) {
                                var finalDate = moment(date).format("YYYY-MM-DD");

                                if (_.isEmpty($startAtInput.data('instance'))) {
                                    finalDate = today;
                                }

                                $startAtInput.data('instance').value = finalDate;
                                self.searchCondition.from = finalDate;

                                if (self.searchCondition.to < finalDate) {
                                    self.searchCondition.to = finalDate;
                                    $endAtInput.data('instance').value = finalDate;
                                }

                                // 날짜 변경에 따른 timepicker 설정. 검색 시작-종료날짜 같은 경우 timepicker의 min-max 값 설정
                                if (self.searchCondition.from == self.searchCondition.to) {
                                    $($("#start-time-mdc").data('instance').input).timepicker('option', 'maxTime', self.searchCondition.endSearchTime);
                                    $($("#end-time-mdc").data('instance').input).timepicker('option', 'minTime', self.searchCondition.startSearchTime);
                                } else {
                                    $($("#start-time-mdc").data('instance').input).timepicker('option', 'maxTime', "23:59");
                                    $($("#end-time-mdc").data('instance').input).timepicker('option', 'minTime', "00:00");
                                }
                            }
                        })));

                        if ($endAtInput.data('datepicker') != null) {
                            $endAtInput.data('datepicker').destroy();
                        }

                        $endAtInput.data('datepicker', new MaterialDatepicker($endAtInput.data('instance').input, $.extend({}, datepickerOption, {
                            onChange: function (date) {
                                var finalDate = moment(date).format("YYYY-MM-DD");

                                if (_.isEmpty($endAtInput.data('instance'))) {
                                    finalDate = today;
                                }

                                $endAtInput.data('instance').value = finalDate;
                                self.searchCondition.to = finalDate;

                                if (self.searchCondition.from > finalDate) {
                                    self.searchCondition.from = finalDate;
                                    $startAtInput.data('instance').value = finalDate;
                                }

                                // 날짜 변경에 따른 timepicker 설정. 검색 시작-종료날짜 같은 경우 timepicker의 min-max 값 설정
                                if (self.searchCondition.from == self.searchCondition.to) {
                                    $($("#start-time-mdc").data('instance').input).timepicker('option', 'maxTime', self.searchCondition.endSearchTime);
                                    $($("#end-time-mdc").data('instance').input).timepicker('option', 'minTime', self.searchCondition.startSearchTime);
                                } else {
                                    $($("#start-time-mdc").data('instance').input).timepicker('option', 'maxTime', "23:59");
                                    $($("#end-time-mdc").data('instance').input).timepicker('option', 'minTime', "00:00");
                                }
                            }
                        })));
                    },
                    initTimepickers: function () {

                        // timepicker 적용
                        var self = this;
                        var $startAtInput = $('#start-time-mdc');
                        var $endAtInput = $('#end-time-mdc');


                        // https://github.com/jonthornton/jquery-timepicker
                        var timepickerOptions = {
                            timeFormat: 'H:i',
                            step: 10,
                            show2400: true,
                            maxTime: "23:59"
                        };

                        $($startAtInput.data('instance').input).timepicker(timepickerOptions)
                            .on('change', function (e) {
                                $startAtInput.data('instance').value = e.target.value;
                                self.searchCondition.startSearchTime = e.target.value;

                                // 검색 시작-종료 날짜가 같은 경우, 종료 timepicker의 최소 시간 = 시작 timepicker의 시간
                                if (self.searchCondition.from == self.searchCondition.to) {
                                    $($("#end-time-mdc").data('instance').input).timepicker('option', 'minTime', self.searchCondition.startSearchTime);
                                } else {
                                    $($("#end-time-mdc").data('instance').input).timepicker('option', 'minTime', "00:00");
                                }
                            });
                        $($endAtInput.data('instance').input).timepicker(timepickerOptions)
                            .on('change', function (e) {
                                $endAtInput.data('instance').value = e.target.value;
                                self.searchCondition.endSearchTime = e.target.value;

                                // 검색 시작-종료 날짜가 같은 경우, 시작 timepicker의 최대 시간 = 종료 timepicker의 시간
                                if (self.searchCondition.from == self.searchCondition.to) {
                                    $($("#start-time-mdc").data('instance').input).timepicker('option', 'maxTime', self.searchCondition.endSearchTime);
                                } else {
                                    $($("#start-time-mdc").data('instance').input).timepicker('option', 'maxTime', "23:59");
                                }
                            });
                    },

                    initSearchBarEvents: function () {
                        var self = this;
                        $('.search-bar input').on("keydown", function (e) {
                            if (e.keyCode == 13) {
                                self.search();
                            }
                        });
                    },

                    initServiceModel: function () {
                        for (var i = 0; i < this.serviceModelList.length; i++) {
                            var serviceModel = this.serviceModelList[i];

                            this.SERVICE_MODEL_ID_TO_NAME[serviceModel.serviceCode] = serviceModel.serviceModelName;
                        }
                    },

                    // mdc-select destroy 후 재생성
                    recreateMdcSelect: function ($mdcSelect) {
                        this.$nextTick(function () {
                            const $select = $mdcSelect[0];
                            $($select).data('instance').destroy();

                            const newMdcSelect = new mdc.select.MDCSelect($select);
                            $($select).data('instance', newMdcSelect);
                        })
                    },

                    // 검색
                    _convertDatetime: function (searchCondition, isStart) {
                        var searchUnit = searchCondition['searchUnit'];

                        var sDate = searchCondition.from;
                        var eDate = searchCondition.to;
                        var sTime = searchCondition.startSearchTime;
                        var eTime = searchCondition.endSearchTime;

                        var finalDate = isStart ? sDate : eDate;
                        var finalTime = isStart ? sTime : eTime;

 						if (searchUnit == "DAY") {
							 return finalDate;
						 }
						 
                        if (searchUnit == "HOUR") {
                            if (isStart) {
                                finalTime = sTime.split(":")[0] + ":00";
                            } else {
                                finalTime = eTime.split(":")[0] + ":59";
                            }
                            return finalDate + " " + finalTime;
                        }
						 
						 return finalDate + " " + finalTime;
                    },
                    _makeSearchConditionQueryString: function () {
                        var searchConditions = {...this.searchCondition}
                        searchConditions['page'] = this.currentPage;

                        // 날짜, 시간 변경
                        var startDatetime = this._convertDatetime(searchConditions, true);
                        var endDatetime = this._convertDatetime(searchConditions, false);

                        searchConditions['from'] = startDatetime;
                        searchConditions['to'] = endDatetime;

                        // 검색 시간, 분 필드 삭제
                        delete searchConditions['startSearchTime'];
                        delete searchConditions['endSearchTime'];

                        this.deleteNullOrDefaultFields(searchConditions);

                        var queryString = Qs.stringify(searchConditions);
                        return queryString;
                    },
                    search: function () {
						
						if (!this.validateDateRange()){
							return;							
						}
						
						this._setSearching(true);

                        var queryString = this._makeSearchConditionQueryString();

                        $.ajax({
                            url: this.baseUrl + "/statistics/api/listPage?" + queryString,
                            method: "get",
                            contentType: 'application/json; charset=UTF-8',
                            dataType: "json"
                        }).done(data => {
                            this._setSearchResultsPageInfo(data); // 검색 결과 페이지 정보 저장
                            this._setSearchResults(data.result); // 검색 결과 목록
                            this._setHashmap(data.hashmap);
                        }).always(() => {
                            this._setSearching(false);
                        })
                    },
                    searchChart : function () {
						
						if (!this.validateDateRange()){
							return;							
						}
						
						this._setSearching(true);

                        var queryString = this._makeSearchConditionQueryString();

                        $.ajax({
                            url: this.baseUrl + "/statistics/api/chartData?" + queryString,
                            method: "get",
                            contentType: 'application/json; charset=UTF-8',
                            dataType: "json"
                        }).done(data => {
							this._setChart(data);
                        }).always(() => {
                            //this._setSearching(false);
                        })
                    },
                    _setSearchResults: function (result) {
                        this.searchResults = result;
                        
                    },
                    _setHashmap: function (hashmap) {
                        this.hashmap = hashmap;
                    },
                    _setSearchResultsPageInfo: function (data) {
                        this.pageInfo.pages = data.pages;
                        this.pageInfo.total = data.total;
                    },
                    _setSearching: function (searching) {
                        this.searching = searching;
                    },
                    _setChart: function (chartData) {
						const searchUnit = chartData.searchUnit;
						const datasets = chartData.datasets;
                        // 데이터 없을 시
                        if (datasets.length !== 0) {
                            $('#noDataTextField')[0].style.display = 'none';
                        } else {
                            $('#noDataTextField')[0].style.display = '';
                        }
                        
                        this.myChart.config.options.scales.x.time.unit = searchUnit.toLowerCase();
                        this.myChart.config.options.scales.x.time.displayFormats = {};
                        
                        if (searchUnit == "MINUTE") {
							this.myChart.config.options.scales.x.time.displayFormats.minute = LABEL.graphAxisUnit.MINUTE;	
						} else if (searchUnit == "HOUR") {
							this.myChart.config.options.scales.x.time.displayFormats.hour = LABEL.graphAxisUnit.HOUR;
						} else {
							this.myChart.config.options.scales.x.time.displayFormats.day = LABEL.graphAxisUnit.DAY;
						}
                        
                        this.myChart.config.data.datasets = datasets;
                        this.myChart.update();
                    },
                    makeGraph: function(graphType) {
						const config = {
	                        type: graphType,
	                        data: this.chartData,
	                        options: {
	                            maxBarThickness: 10,
	                            layout: {
									padding: {
											right: 50
									}
								},
	                            scales: {
									 x: {
										type: "time",
										time: {
											unit: 'minute',
											tooltipFormat: "yyyy-MM-DD HH:mm:ss",
											displayFormats: {
												minute: 'yyyy-MM-DD HH:mm:ss'
											}
										},
	                                    ticks: {
	                                        //maxTicksLimit: 10, // 라벨 출력개수
	                                        //maxRotation: 30, // 라벨 많을 때 라벨 최대 회전 
	                                    },
	                                },
	                                y: {
										beginAtZero: true,
	                                    ticks: {
	                                        precision: 0,
	                                        callback: function(value, index, ticks) {
	                                            return value+"건"
	                                        }
	                                    },
	                                },
	                            },
	                            plugins: {
	                                legend: {
	                                    position: 'bottom',
	                                }
	                            }
	                        }
	                    };
						
	                    this.myChart = new Chart(
	                        document.getElementById('myChart'),
	                        config
	                    );
					},
                    onClickGraphType: function(e) {
						const graphType = e.target.value;
						this.myChart.config.type = graphType;
						this.myChart.update();
					},
                    onClickSearchUnit: function (e) {
                        this.searchCondition.searchUnit = e.target.value;

                        if (this.searchCondition.searchUnit == "MINUTE") {
                            $($("#start-time-mdc").data('instance')).prop("disabled", false);
                            $($("#end-time-mdc").data('instance')).prop("disabled", false);

                            // 시작시간 00:00, timepicker 분 간격 10분
                            $($("#start-time-mdc").data('instance').input).timepicker('setTime', "00:00");
                            $($("#start-time-mdc").data('instance').input).timepicker('option', 'step', '10');

                            // 종료시간 23:59, timepicker 분 간격 10분
                            $($("#end-time-mdc").data('instance').input).timepicker('setTime', "23:59");
                            $($("#end-time-mdc").data('instance').input).timepicker('option', 'step', '10');


                        } else if (this.searchCondition.searchUnit == "HOUR") {
                            $($("#start-time-mdc").data('instance')).prop("disabled", false);
                            $($("#end-time-mdc").data('instance')).prop("disabled", false);

                            // 시작시간 00:00, timepicker 분 간격 60분
                            $($("#start-time-mdc").data('instance').input).timepicker('setTime', "00:00");
                            $($("#start-time-mdc").data('instance').input).timepicker('option', 'step', '60');

                            // 종료시간 23:59, timepicker 분 간격 60분
                            $($("#end-time-mdc").data('instance').input).timepicker('setTime', "23:59");
                            $($("#end-time-mdc").data('instance').input).timepicker('option', 'step', '60');

                        } else if (this.searchCondition.searchUnit == "DAY") {
                            $($("#start-time-mdc").data('instance')).prop("disabled", true);
                            $($("#end-time-mdc").data('instance')).prop("disabled", true);

                            // 시작시간 00:00
                            $($("#start-time-mdc").data('instance').input).timepicker('setTime', "00:00");
                            // 종료시간 23:59
                            $($("#end-time-mdc").data('instance').input).timepicker('setTime', "23:59");

                        } else { // MONTH
                            $($("#start-time-mdc").data('instance')).prop("disabled", true);
                            $($("#end-time-mdc").data('instance')).prop("disabled", true);

                            // 시작시간 00:00
                            $($("#start-time-mdc").data('instance').input).timepicker('setTime', "00:00");
                            // 종료시간 23:59
                            $($("#end-time-mdc").data('instance').input).timepicker('setTime', "23:59");
                        }
                    },
                    // 페이지네이션
                    gotoPage: function (pageNum) {
                        let validPageNum = pageNum;
                        if (pageNum < 1) {
                            validPageNum = 1;
                        } else if (pageNum > this.pageInfo.pages) {
                            validPageNum = this.pageInfo.pages;
                        }

                        this.currentPage = validPageNum;
                        this.search();
                    },
                    convertServiceModelId2Name: function(id) {
                        return this.SERVICE_MODEL_ID_TO_NAME[id];
                    },
                    deleteNullOrDefaultFields: function (obj) {
                        for (var key of Object.keys(obj)) {
                            if (obj[key] == null || obj[key] == undefined) {
                                delete obj[key];
                            }
                            if (typeof obj[key] == "number" && obj[key] == 0) {
                                delete obj[key];
                            }
                            if (typeof obj[key] == "string" && obj[key] == '') {
                                delete obj[key];
                            }
                        }
                    },
                    validateDateRange: function () {
						const from = new Date(this.searchCondition.from);
						const to = new Date(this.searchCondition.to);

						const diffMSec = to.getTime() - from.getTime();
						const diffDate = diffMSec / (24 * 60 * 60 * 1000);

						if (diffDate > 31) {
							toastr.error(LABEL.message.OVER_DATE_RANGE);
							return false;
						}

						return true;
					}
                }
            });
        })
        ();
    </script>
</th:block>


</html>
